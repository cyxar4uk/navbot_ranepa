name: Deploy to Server

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            PROJECT_DIR="/www/wwwroot/testingsmth.anyway-community.ru/navbot_ranepa"
            cd "$PROJECT_DIR" || exit 1
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–µ—Å—Ç—å docker-compose.yml)
            if [ ! -f "docker-compose.yml" ]; then
              echo "‚ùå Error: docker-compose.yml not found. Wrong directory?"
              exit 1
            fi
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ —Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            # –î–µ–ª–∞–µ–º hard reset –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º (–ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã)
            echo "üì• Fetching latest changes..."
            git fetch origin
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            REMOTE_BRANCH="origin/main"
            if [ "$CURRENT_BRANCH" = "master" ] || git rev-parse --verify origin/master >/dev/null 2>&1; then
              REMOTE_BRANCH="origin/master"
            fi
            
            echo "üîÑ Resetting to $REMOTE_BRANCH..."
            git reset --hard $REMOTE_BRANCH
            git clean -fd  # –£–¥–∞–ª—è–µ–º –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã
            
            # –†–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º -f –¥–ª—è —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è —Ñ–∞–π–ª–∞)
            echo "üõë Stopping containers..."
            docker-compose -f docker-compose.yml down --remove-orphans
            
            echo "üßπ Cleaning old containers and images..."
            # –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
            docker ps -a --filter "name=navbot" -q | xargs -r docker rm -f 2>/dev/null || true
            
            # –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞
            docker images --filter "reference=navbot_ranepa*" -q | xargs -r docker rmi -f 2>/dev/null || true
            
            # –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            docker image prune -f
            
            echo "üî® Building and starting containers..."
            docker-compose -f docker-compose.yml build --no-cache
            docker-compose -f docker-compose.yml up -d
            
            echo "üóÑÔ∏è Running database migrations..."
            sleep 5  # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ë–î
            docker-compose -f docker-compose.yml exec -T backend alembic upgrade head 2>/dev/null || echo "‚ö†Ô∏è Migrations skipped or already applied"
            
            echo "‚úÖ Checking container status..."
            docker-compose -f docker-compose.yml ps
            
            echo "üîç Waiting for services to be ready..."
            sleep 10
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
            if ! docker-compose -f docker-compose.yml ps | grep -q "Up"; then
              echo "‚ùå Warning: Some containers may not be running"
              docker-compose -f docker-compose.yml ps
            else
              echo "‚úÖ All containers are running"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend (–ø–æ—Ä—Ç 8001 –Ω–∞ —Ö–æ—Å—Ç–µ)
            echo "üåê Checking backend health..."
            if curl -f http://127.0.0.1:8001/health >/dev/null 2>&1; then
              echo "‚úÖ Backend is healthy"
            else
              echo "‚ö†Ô∏è Backend health check failed (may need more time to start)"
            fi
      
      - name: Notify deployment status
        if: always()
        run: |
          echo "Deployment completed"
