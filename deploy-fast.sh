#!/bin/bash

# –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Docker –∫—ç—à–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-fast.sh [service1] [service2] ...
# –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã —Å–µ—Ä–≤–∏—Å—ã, –ø–µ—Ä–µ—Å–æ–±–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–Ω–∏, –∏–Ω–∞—á–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ

set -e

echo "üöÄ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º..."

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose down --remove-orphans

# –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã, –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏—Ö
if [ $# -gt 0 ]; then
    echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: $@"
    docker-compose build "$@"
else
    echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (—Å –∫—ç—à–µ–º)..."
    # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (Docker —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º)
    docker-compose build
fi

# –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ dangling images (–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ–±—Ä–∞–∑—ã)
echo "üßπ –û—á–∏—Å—Ç–∫–∞ dangling images..."
docker image prune -f

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è backend
echo ""
echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è backend..."
sleep 3
if curl -f -s http://127.0.0.1:${BACKEND_PORT:-8001}/health >/dev/null 2>&1; then
    echo "‚úÖ Backend –∑–¥–æ—Ä–æ–≤"
else
    echo "‚ö†Ô∏è Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏)"
fi

echo ""
echo "‚úÖ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
